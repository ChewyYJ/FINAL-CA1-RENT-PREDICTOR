{% extends "layout.html" %}

{% block title %}UAE Rental Price Prediction{% endblock %}

{% block content %}

<!-- HERO SECTION - Full Page -->
<section class="hero-section d-flex align-items-center justify-content-center">
    <div class="container">
        <div class="row align-items-center g-4 g-lg-5">
            <!-- Hero text -->
            <div class="col-lg-6 text-center text-lg-start">
                <p class="text-uppercase small mb-3 fw-semibold">
                    <i class="bi bi-graph-up-arrow me-1"></i> AI-Powered Rental Insights
                </p>
                <h1 class="hero-title text-uppercase mb-4">
                    SMART PROPERTY <br>
                    <span class="highlight-teal">RENT PREDICTIONS</span> <br>
                    ACROSS THE <span class="highlight-teal">UAE</span>
                </h1>
                <p class="mb-5" style="font-size: 1.1rem; line-height: 1.7;">
                    Get fast, data-driven rent estimates for apartments and villas across 8 major cities including
                    Dubai, Abu Dhabi, Sharjah, Ajman, Ras Al Khaimah, Fujairah, Umm Al Quwain, and Al Ain.
                    Adjust key details to see how location, size, and furnishing impact annual rental value.
                </p>

                <div class="features-list mb-5">
                    <span><i class="bi bi-lightning-charge-fill"></i> Instant predictions</span>
                    <span><i class="bi bi-check-circle-fill"></i> 73K+ listings</span>
                    <span><i class="bi bi-geo-fill"></i> 8 UAE cities</span>
                </div>

                <!-- Predict Now Button -->
                <div class="d-flex justify-content-center justify-content-lg-start">
                    <a href="#predict-form"
                       class="btn btn-primary btn-lg px-5 py-3 predict-btn-main"
                       style="font-size: 1.1rem; font-weight: 600; text-decoration: none;">
                        <i class="bi bi-calculator me-2"></i>
                        Predict Now
                        <i class="bi bi-arrow-down ms-2"></i>
                    </a>
                </div>
            </div>

            <!-- Hero image -->
            <div class="col-lg-6">
                <div class="glass-card position-relative rounded-4 shadow-lg p-0">
                    <img src="{{ url_for('static', filename='images/dubai_morn.jpg') }}"
                         alt="UAE rental apartments"
                         class="img-fluid w-100 rounded-4"
                         style="object-fit: cover; height: 450px; object-position: center;">
                </div>
            </div>
        </div>
    </div>
</section>

<!-- FORM SECTION - Full Page Centered -->
<section class="form-section d-flex align-items-center justify-content-center" id="predict-form">
    <div class="container">
        <div class="card shadow-sm border-0 rounded-4 predict-card">
            <div class="card-body p-4 p-md-5">
                <div class="d-flex flex-column flex-md-row justify-content-between align-items-start align-items-md-center mb-4">
                    <div>
                        <h5 class="fw-semibold mb-1">
                            Enter Property Details
                        </h5>
                        <p class="text-muted small mb-0">
                            Fill in the fields below and click <span class="fw-semibold">Predict Rent</span> to get an annual estimate in AED.
                        </p>
                    </div>
                </div>

                <form method="POST" action="{{ url_for('predict') }}" novalidate>
                    {{ form.hidden_tag() }}

                    <div class="row g-3 g-md-4">
                        <!-- Location with Autocomplete -->
                        <div class="col-md-6">
                            <label for="{{ form.location.id }}" class="form-label">
                                <i class="bi bi-geo-alt me-1"></i> Location
                            </label>
                            {{ form.location(class="form-control", list="location-list", placeholder="Type or select a location...") }}

                            <!-- Datalist for autocomplete dropdown -->
                            <datalist id="location-list">
                                {% for loc in locations %}
                                    <option value="{{ loc }}"></option>
                                {% endfor %}
                            </datalist>
                        </div>

                        <div class="col-md-6">
                            <label for="{{ form.city.id }}" class="form-label fw-semibold">
                                <i class="bi bi-building me-1"></i> City
                            </label>
                            {{ form.city(class="form-select") }}
                        </div>

                        <!-- Property Type / Furnishing / Age -->
                        <div class="col-md-4">
                            <label for="{{ form.type.id }}" class="form-label fw-semibold mt-2 mt-md-3">
                                <i class="bi bi-houses me-1"></i> Property Type
                            </label>
                            {{ form.type(class="form-select") }}
                        </div>

                        <div class="col-md-4">
                            <label for="{{ form.furnishing.id }}" class="form-label fw-semibold mt-2 mt-md-3">
                                <i class="bi bi-lamp me-1"></i> Furnishing
                            </label>
                            {{ form.furnishing(class="form-select") }}
                        </div>

                        <div class="col-md-4">
                            <label for="{{ form.age_of_listing_in_days.id }}" class="form-label fw-semibold mt-2 mt-md-3">
                                <i class="bi bi-calendar-event me-1"></i> Age of Listing (days)
                            </label>
                            {{ form.age_of_listing_in_days(class="form-control", placeholder="e.g. 7") }}
                        </div>

                        <!-- Beds / Baths -->
                        <div class="col-md-6">
                            <label for="{{ form.beds.id }}" class="form-label fw-semibold mt-2 mt-md-3">
                                <i class="bi bi-door-closed me-1"></i> Bedrooms
                            </label>
                            {{ form.beds(class="form-control", placeholder="e.g. 2") }}
                        </div>
                        <div class="col-md-6">
                            <label for="{{ form.baths.id }}" class="form-label fw-semibold mt-2 mt-md-3">
                                <i class="bi bi-droplet me-1"></i> Bathrooms
                            </label>
                            {{ form.baths(class="form-control", placeholder="e.g. 2") }}
                        </div>

                        <!-- Area + Button -->
                        <div class="col-md-9">
                            <label for="{{ form.area_in_sqft.id }}" class="form-label fw-semibold mt-2 mt-md-3">
                                <i class="bi bi-grid-1x2 me-1"></i> Area (sqft)
                            </label>
                            {{ form.area_in_sqft(class="form-control", placeholder="e.g. 850") }}
                            <div class="form-text">Typical units range between 300 – 5,000 sq ft.</div>
                        </div>

                        <div class="col-md-3 d-flex align-items-end mt-2 mt-md-4">
                            {{ form.submit(class="btn btn-primary w-100 predict-btn-main py-2 py-md-3") }}
                        </div>
                    </div>
                </form>
            </div>
        </div>
    </div>
</section>

{% if entries %}
<!-- RESULT + HISTORY SECTION - Full Page Centered -->
<section class="results-section d-flex align-items-center justify-content-center" id="history-card">
    <div class="container">
        <!-- Main Result + History Card -->
        <div class="card border-0 rounded-4 shadow-sm glass-card">
            <!-- Card header -->
            <div class="border-bottom px-4 px-md-5 pt-4 pb-3 d-flex flex-column flex-md-row justify-content-between align-items-start align-items-md-center">
                <div>
                    <h5 class="mb-1 d-flex align-items-center">
                        <i class="bi bi-house-check-fill me-2"></i>
                        Your Latest Rent Estimate
                    </h5>
                    <p class="text-muted small mb-0">
                        Review the estimated annual rent and your previous predictions below.
                    </p>
                </div>
                <span class="badge mt-3 mt-md-0 px-3 py-2"
                      style="background-color: var(--primary-teal); color: white; border-radius:999px;">
                    {{ pagination.total }} prediction{{ '' if pagination.total == 1 else 's' }} saved
                </span>
            </div>

            <div class="card-body p-4 p-md-5">

                <!-- Headline row -->
                <div class="d-flex flex-column flex-lg-row justify-content-between align-items-start align-items-lg-center mb-4 gap-3">
                    <div>
                        <p class="text-uppercase small text-muted mb-1 fw-semibold">
                            Estimated Annual Rent
                        </p>

                        <div class="d-flex flex-wrap align-items-baseline gap-2">
                            <h1 class="mb-0 fw-bold rent-estimate-text">
                                {{ "AED {:,.0f}".format(latest.predicted_rent) }}
                            </h1>
                            <span class="text-muted small">per year</span>
                        </div>
                        <p class="text-muted small mb-0 mt-1">
                            ≈ {{ "AED {:,.0f}".format(latest.predicted_rent / 12) }} per month
                        </p>
                    </div>
                </div>

                <div class="row g-4">
                    <!-- Property summary -->
                    <div class="col-md-5">
                        <div class="card border-0 shadow-sm rounded-4 h-100 property-summary-card">
                            <div class="card-body">
                                <h6 class="fw-semibold mb-3 d-flex align-items-center">
                                    <i class="bi bi-info-circle me-2"></i> Property Summary
                                </h6>

                                <dl class="row mb-0 small">
                                    <dt class="col-6 text-muted">Type</dt>
                                    <dd class="col-6 text-end fw-semibold">{{ latest.property_type }}</dd>

                                    <dt class="col-6 text-muted">Area</dt>
                                    <dd class="col-6 text-end fw-semibold">{{ latest.area }} sq ft</dd>

                                    <dt class="col-6 text-muted">Bedrooms</dt>
                                    <dd class="col-6 text-end fw-semibold">{{ latest.bedrooms }}</dd>

                                    <dt class="col-6 text-muted">Bathrooms</dt>
                                    <dd class="col-6 text-end fw-semibold">{{ latest.bathrooms }}</dd>

                                    <dt class="col-6 text-muted">Furnishing</dt>
                                    <dd class="col-6 text-end fw-semibold">{{ latest.furnishing }}</dd>

                                    <dt class="col-6 text-muted">Location</dt>
                                    <dd class="col-6 text-end fw-semibold text-truncate">{{ latest.location }}</dd>

                                    <dt class="col-6 text-muted">City</dt>
                                    <dd class="col-6 text-end fw-semibold">{{ latest.city }}</dd>

                                    <dt class="col-6 text-muted">Listing Age</dt>
                                    <dd class="col-6 text-end fw-semibold">{{ latest.age_of_listing }} days</dd>
                                </dl>
                            </div>
                        </div>
                    </div>

                    <!-- History table -->
                    <div class="col-md-7">
                        <div class="d-flex justify-content-between align-items-center mb-3">
                            <h6 class="fw-semibold mb-0 d-flex align-items-center">
                                <i class="bi bi-clock-history me-2"></i> Prediction History
                            </h6>
                        <a href="{{ url_for('history') }}" class="btn btn-sm px-2 py-1 history-btn">
                            <i class="bi bi-table me-1" style="font-size: 0.8rem;"></i> View Full History
                        </a>
                        </div>
                        <div class="table-responsive">
                            <table class="table table-sm align-middle table-hover mb-0">
                                <thead class="table-light small text-nowrap">
                                    <tr>
                                        <th>Price (AED/yr)</th>
                                        <th>Area</th>
                                        <th class="d-none d-sm-table-cell">Beds</th>
                                        <th class="d-none d-sm-table-cell">Baths</th>
                                        <th class="d-none d-md-table-cell">Furnishing</th>
                                        <th class="d-none d-lg-table-cell">Location</th>
                                        <th>City</th>
                                        <th class="d-none d-md-table-cell">Age (days)</th>
                                        <th class="d-none d-lg-table-cell">Type</th>
                                        <th class="d-none d-lg-table-cell">Created</th>
                                        <th class="text-end"></th>
                                    </tr>
                                </thead>
                                <tbody>
                                {% for e in entries %}
                                    <tr class="small {% if e.id == latest.id %}table-primary-subtle{% endif %}">
                                        <td class="fw-semibold rent-estimate-text text-nowrap">
                                            {{ "AED {:,.0f}".format(e.predicted_rent) }}
                                            {% if e.id == latest.id %}
                                                <span class="badge bg-success-subtle text-success ms-1">Latest</span>
                                            {% endif %}
                                        </td>
                                        <td>{{ e.area }}</td>
                                        <td class="d-none d-sm-table-cell">{{ e.bedrooms }}</td>
                                        <td class="d-none d-sm-table-cell">{{ e.bathrooms }}</td>
                                        <td class="d-none d-md-table-cell">{{ e.furnishing }}</td>
                                        <td class="d-none d-lg-table-cell text-truncate" style="max-width: 120px;">
                                            {{ e.location }}
                                        </td>
                                        <td>{{ e.city }}</td>
                                        <td class="d-none d-md-table-cell">{{ e.age_of_listing }}</td>
                                        <td class="d-none d-lg-table-cell">{{ e.property_type }}</td>
                                        <td class="d-none d-lg-table-cell">
                                            {{ e.created_at.strftime('%d %b %Y') }}
                                        </td>
                                        <td class="text-end">
                                            <button type="button"
                                                    class="btn btn-sm btn-outline-danger px-2"
                                                    data-bs-toggle="modal"
                                                    data-bs-target="#confirmDeleteModal"
                                                    data-entry-id="{{ e.id }}">
                                                <i class="bi bi-x-lg"></i>
                                            </button>
                                        </td>

                                    </tr>
                                {% endfor %}
                                </tbody>
                            </table>
                        </div>

                        {% if pagination and pagination.pages > 1 %}
                        <nav aria-label="Prediction history pages" class="mt-3">
                            <ul class="pagination pagination-sm justify-content-end mb-0">
                                <!-- Previous -->
                                <li class="page-item {% if not pagination.has_prev %}disabled{% endif %}">
                                    <a class="page-link"
                                       href="{{ url_for('index_page', page=pagination.prev_num, _anchor='history-card') }}">
                                        &laquo;
                                    </a>
                                </li>

                                <!-- Page numbers -->
                                {% for p in pagination.iter_pages(left_edge=1, right_edge=1,
                                                                  left_current=1, right_current=1) %}
                                    {% if p %}
                                        <li class="page-item {% if p == pagination.page %}active{% endif %}">
                                            <a class="page-link"
                                               href="{{ url_for('index_page', page=p, _anchor='history-card') }}">
                                                {{ p }}
                                            </a>
                                        </li>
                                    {% else %}
                                        <li class="page-item disabled">
                                            <span class="page-link">…</span>
                                        </li>
                                    {% endif %}
                                {% endfor %}

                                <!-- Next -->
                                <li class="page-item {% if not pagination.has_next %}disabled{% endif %}">
                                    <a class="page-link"
                                       href="{{ url_for('index_page', page=pagination.next_num, _anchor='history-card') }}">
                                        &raquo;
                                    </a>
                                </li>
                            </ul>
                        </nav>
                        {% endif %}
                    </div>
                </div>
            </div>
        </div>
    </div>
</section>
{% endif %}


<!-- Smooth Scroll Script for anchor links (hero button, etc.) -->
<script>
    document.querySelectorAll('a[href^="#"]').forEach(anchor => {
        anchor.addEventListener('click', function (e) {
            const target = document.querySelector(this.getAttribute('href'));
            if (!target) return;
            e.preventDefault();
            target.scrollIntoView({
                behavior: 'smooth',
                block: 'start'
            });
        });
    });
</script>
<!-- Delete Confirmation Modal -->
<div class="modal fade" id="confirmDeleteModal" tabindex="-1">
  <div class="modal-dialog modal-dialog-centered">
    <div class="modal-content rounded-4">

      <div class="modal-header">
        <h5 class="modal-title">Delete Prediction</h5>
        <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
      </div>

      <div class="modal-body">
        Are you sure you want to delete this prediction? This action cannot be undone.
      </div>

      <div class="modal-footer">
        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>

        <form id="deleteForm" method="POST" action="{{ url_for('remove') }}">
          <input type="hidden" name="id" id="deleteEntryId">
            <input type="hidden" name="source" value="index">

          <button type="submit" class="btn btn-danger">Delete</button>
        </form>
      </div>

    </div>
  </div>
</div>
<script>
document.getElementById('confirmDeleteModal').addEventListener('show.bs.modal', function (event) {
    const button = event.relatedTarget;  
    const entryId = button.getAttribute('data-entry-id');  
    document.getElementById('deleteEntryId').value = entryId;  
});
</script>

{% endblock %}
